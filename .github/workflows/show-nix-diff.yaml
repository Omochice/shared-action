name: Comment nix flake differences

on:
  workflow_call:
    inputs:
      attribute:
        description: The attribute name like "devShells.x86_64.default"
        type: string
        required: true
    secrets:
      token:
        description: GitHub token for setup nix
        required: true

jobs:
  comment-diff:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: ./.github/actions/setup-nix
        with:
          github-token: ${{ secrets.token }}
      - run: nix profile install nixpkgs#dix
      - name: Run dix
        id: dix
        # NOTE: referred to natsukium/dotfiles
        env:
          ATTRIBUTE: ${{ inputs.attribute }}
        run: |
          DIX_OUTPUT="$(dix \
            "$(nix path-info --derivation "github:${{ github.repository }}#${ATTRIBUTE}")" \
            "$(nix path-info --derivation ".#${ATTRIBUTE}")" \
            2>&1)" || DIX_OUTPUT="Failed to execute dix"

          # Extract drv paths from <<< and >>> lines
          OLD_DRV="$(echo "$DIX_OUTPUT" | grep '^<<<' | sed 's/^<<< //')"
          NEW_DRV="$(echo "$DIX_OUTPUT" | grep '^>>>' | sed 's/^>>> //')"

          if [ "$OLD_DRV" = "$NEW_DRV" ] && [ -n "$OLD_DRV" ]; then
            {
              echo 'DIFF_OUTPUT<<EOF'
              echo "# \`${ATTRIBUTE}\` changes"
              echo ''
              echo 'No changes detected.'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo 'DIFF_OUTPUT<<EOF'
              echo "# \`${ATTRIBUTE}\` changes"
              echo ''
              echo '```console'
              echo "$DIX_OUTPUT"
              echo '```'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi
      - uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          message: ${{ steps.dix.outputs.DIFF_OUTPUT }}
          header: ${{ inputs.attribute }}
